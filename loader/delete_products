import requests
from lxml import etree
from dotenv import load_dotenv
import os
import urllib3

urllib3.disable_warnings()
load_dotenv()

API_URL = os.getenv("PS_API_URL")
API_KEY = os.getenv("PS_API_KEY")

if not API_URL or not API_KEY:
    raise ValueError("Missing PRESTASHOP_URL or PRESTASHOP_API_KEY")

headers = {"Accept": "application/xml"}

def delete_product(product_id: int):
    url = f"{API_URL}/products/{product_id}"
    resp = requests.delete(url, auth=(API_KEY, ""), headers=headers, verify=False)

    if resp.status_code in (200, 201):
        print(f"ğŸ—‘ï¸ UsuniÄ™to produkt ID: {product_id}")
    else:
        print(f"âŒ BÅ‚Ä…d usuwania produktu {product_id}: {resp.status_code}")
        print(resp.text)


def get_all_products():
    url = f"{API_URL}/products?display=[id]"
    resp = requests.get(url, auth=(API_KEY, ""), headers=headers, verify=False)

    if resp.status_code != 200:
        print("âŒ Nie mogÄ™ pobraÄ‡ listy produktÃ³w")
        print("STATUS:", resp.status_code)
        print(resp.text)
        return []

    tree = etree.fromstring(resp.content)
    ids = tree.xpath("//product/id/text()")
    return [int(x) for x in ids]


def main():
    print("Pobieram listÄ™ produktÃ³wâ€¦")
    product_ids = get_all_products()

    if not product_ids:
        print("Brak produktÃ³w do usuniÄ™cia.")
        return

    print(f"Znaleziono {len(product_ids)} produktÃ³w. Usuwamâ€¦")

    for pid in product_ids:
        delete_product(pid)

    print("\nâœ” GOTOWE â€“ wszystkie produkty usuniÄ™te.")


if __name__ == "__main__":
    main()
